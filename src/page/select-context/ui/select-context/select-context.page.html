<div class="flex h-screen flex-col bg-gray-50">

  <!-- HEADER FIXED -->
  <header class="shrink-0 border-b border-gray-200 bg-white px-4 py-4 lg:px-8 lg:py-6">
    <div class="mx-auto max-w-7xl">
      <app-context-hero
        [currentStep]="store.currentStep()"
        [selectedClientName]="store.selectedClient()?.name ?? null" />
    </div>
  </header>

  <!-- MAIN CONTENT SCROLLABLE -->
  <main class="flex-1 overflow-hidden px-4 py-6 lg:px-8">
    <div class="mx-auto flex h-full max-w-7xl flex-col">

      <!-- DESKTOP: Dual Scroll Layout -->
      <div class="hidden h-full lg:grid lg:grid-cols-2 lg:gap-6">

        <!-- COLUMN 1: CLIENTES (Independent Scroll) -->
        <section class="flex min-h-0 flex-col">
          <!-- Section Header (Fixed) -->
          <div class="mb-4 flex shrink-0 items-center gap-3">
            <app-entity-icon
              [entity]="IconEntity.CLIENT"
              [size]="IconSize.MD"
              [rounded]="IconRounded.LG"
              [customClasses]="'bg-sky-100 text-sky-600'" />
            <div class="flex-1">
              <h2 class="text-lg font-semibold text-gray-900">
                Clientes
              </h2>
              <p class="text-sm text-gray-600">
                Elige el cliente con el que trabajarás
              </p>
            </div>
          </div>

          <!-- Scrollable Content -->
          <div class="min-h-0 flex-1 overflow-y-auto">
            <div class="pr-2">

              <!-- Loading State -->
              @if (store.isLoadingClients()) {
                <div class="space-y-4">
                  @for (i of [1, 2]; track i) {
                    <div class="animate-pulse overflow-hidden rounded-xl border-2 border-gray-200 bg-white">
                      <div class="h-32 bg-gray-200"></div>
                      <div class="flex items-center gap-4 p-5">
                        <div class="h-16 w-16 rounded-full bg-gray-200"></div>
                        <div class="flex-1 space-y-2">
                          <div class="h-4 w-3/4 rounded bg-gray-200"></div>
                          <div class="h-3 w-1/2 rounded bg-gray-200"></div>
                        </div>
                      </div>
                    </div>
                  }
                </div>
              }

              @else if (store.clientsError()) {
                <div class="rounded-xl border-2 border-red-200 bg-red-50 p-8 text-center">
                  <i class="pi pi-exclamation-circle mb-4 text-4xl text-red-500"></i>
                  <h3 class="mb-2 text-lg font-semibold text-red-900">
                    Error al cargar clientes
                  </h3>
                  <p class="mb-4 text-sm text-red-700">
                    {{ store.clientsError() }}
                  </p>
                  <button
                    pRipple
                    type="button"
                    (click)="onRetryClients()"
                    class="rounded-lg bg-red-500 px-4 py-2 text-sm font-semibold text-white transition-all hover:bg-red-600">
                    <i class="pi pi-refresh mr-2"></i>
                    Reintentar
                  </button>
                </div>
              }

              @else if (!store.hasClients()) {
                <div class="rounded-xl border-2 border-dashed border-gray-300 bg-white p-8 text-center">
                  <i class="pi pi-inbox mb-4 text-4xl text-gray-400"></i>
                  <h3 class="mb-2 text-lg font-semibold text-gray-900">
                    No hay clientes disponibles
                  </h3>
                  <p class="text-sm text-gray-600">
                    Contacta al administrador para obtener acceso
                  </p>
                </div>
              }

              @else {
                <div class="space-y-4 pb-4 flex flex-col gap-x-1">
                  @for (client of store.clients(); track client.id) {
                    <app-client-card
                      [client]="client"
                      [isSelected]="store.selectedClient()?.id === client.id"
                      [clickable]="true"
                      (cardClick)="onClientSelect($event)" />
                  }
                </div>
              }
            </div>
          </div>
        </section>

        <!-- COLUMN 2: PROYECTOS (Independent Scroll) -->
        <section class="flex min-h-0 flex-col">
          <!-- Section Header (Fixed) -->
          <div class="mb-4 flex shrink-0 items-center gap-3">
            <app-entity-icon
              [entity]="IconEntity.PROJECT"
              [size]="IconSize.MD"
              [rounded]="IconRounded.LG"
              [customClasses]="'bg-cyan-100 text-cyan-600'" />
            <div class="flex-1">
              <h2 class="text-lg font-semibold text-gray-900">
                Proyectos
              </h2>
              @if (store.selectedClient()) {
                <p class="text-sm text-gray-600">
                  Proyectos de <span class="font-semibold">{{ store.selectedClient()!.name }}</span>
                </p>
              } @else {
                <p class="text-sm text-gray-600">
                  Primero selecciona un cliente
                </p>
              }
            </div>
          </div>

          <!-- Scrollable Content -->
          <div class="min-h-0 flex-1 overflow-y-auto">
            <div class="pr-2 h-full">

              <!-- Disabled State -->
              @if (!store.selectedClient()) {
                <div class=" h-full flex flex-col items-center justify-center rounded-xl border-2 border-dashed border-gray-300 bg-gray-50 p-8 text-center opacity-60">
                  <i class="pi pi-arrow-left mb-4 text-4xl text-gray-400"></i>
                  <h3 class="mb-2 text-lg font-semibold text-gray-700">
                    Selecciona un cliente
                  </h3>
                  <p class="text-sm text-gray-600">
                    Los proyectos se mostrarán después de seleccionar un cliente
                  </p>
                </div>
              }

              @else if (store.isLoadingProjects()) {
                <div class="space-y-4">
                  @for (i of [1, 2]; track i) {
                    <div class="animate-pulse overflow-hidden rounded-xl border-2 border-gray-200 bg-white">
                      <div class="h-40 bg-gray-200"></div>
                      <div class="space-y-3 p-5">
                        <div class="h-4 w-3/4 rounded bg-gray-200"></div>
                        <div class="h-3 w-1/2 rounded bg-gray-200"></div>
                        <div class="flex gap-2">
                          <div class="h-6 w-20 rounded-full bg-gray-200"></div>
                          <div class="h-6 w-20 rounded-full bg-gray-200"></div>
                        </div>
                      </div>
                    </div>
                  }
                </div>
              }

              @else if (store.projectsError()) {
                <div class="rounded-xl border-2 border-red-200 bg-red-50 p-8 text-center">
                  <i class="pi pi-exclamation-circle mb-4 text-4xl text-red-500"></i>
                  <h3 class="mb-2 text-lg font-semibold text-red-900">
                    Error al cargar proyectos
                  </h3>
                  <p class="mb-4 text-sm text-red-700">
                    {{ store.projectsError() }}
                  </p>
                  <button
                    pRipple
                    type="button"
                    (click)="onRetryProjects()"
                    class="rounded-lg bg-red-500 px-4 py-2 text-sm font-semibold text-white transition-all hover:bg-red-600">
                    <i class="pi pi-refresh mr-2"></i>
                    Reintentar
                  </button>
                </div>
              }

              @else if (!store.hasProjects()) {
                <div class="rounded-xl border-2 border-dashed border-gray-300 bg-white p-8 text-center">
                  <i class="pi pi-inbox mb-4 text-4xl text-gray-400"></i>
                  <h3 class="mb-2 text-lg font-semibold text-gray-900">
                    No hay proyectos disponibles
                  </h3>
                  <p class="text-sm text-gray-600">
                    Este cliente no tiene proyectos asignados
                  </p>
                </div>
              }

              @else {
                <div class="space-y-4 pb-4 flex flex-col gap-x-1">
                  @for (project of store.projects(); track project.id) {
                    <app-project-card
                      [project]="project"
                      [isSelected]="store.selectedProject()?.id === project.id"
                      [clickable]="true"
                      (cardClick)="onProjectSelect($event)" />
                  }
                </div>
              }
            </div>
          </div>
        </section>

      </div>

      <!-- MOBILE: Stepper Layout (sin cambios) -->
      <div class="h-full lg:hidden">

        <!-- Step 1: Clientes -->
        @if (store.currentStep() === SelectContextStep.SELECT_CLIENT)  {
          <div class="flex h-full flex-col">
            <div class="flex-1 overflow-y-auto">

              <!-- Loading State -->
              @if (store.isLoadingClients()) {
                <div class="space-y-4">
                  @for (i of [1, 2, 3]; track i) {
                    <div class="animate-pulse overflow-hidden rounded-xl border-2 border-gray-200 bg-white">
                      <div class="h-32 bg-gray-200"></div>
                      <div class="flex items-center gap-4 p-5">
                        <div class="h-16 w-16 rounded-full bg-gray-200"></div>
                        <div class="flex-1 space-y-2">
                          <div class="h-4 w-3/4 rounded bg-gray-200"></div>
                          <div class="h-3 w-1/2 rounded bg-gray-200"></div>
                        </div>
                      </div>
                    </div>
                  }
                </div>
              }

              @else if (store.clientsError()) {
                <div class="rounded-xl border-2 border-red-200 bg-red-50 p-8 text-center">
                  <i class="pi pi-exclamation-circle mb-4 text-4xl text-red-500"></i>
                  <h3 class="mb-2 text-lg font-semibold text-red-900">
                    Error al cargar clientes
                  </h3>
                  <p class="mb-4 text-sm text-red-700">
                    {{ store.clientsError() }}
                  </p>
                  <button
                    pRipple
                    type="button"
                    (click)="onRetryClients()"
                    class="rounded-lg bg-red-500 px-4 py-2 text-sm font-semibold text-white transition-all hover:bg-red-600">
                    <i class="pi pi-refresh mr-2"></i>
                    Reintentar
                  </button>
                </div>
              }

              @else if (!store.hasClients()) {
                <div class="rounded-xl border-2 border-dashed border-gray-300 bg-white p-8 text-center">
                  <i class="pi pi-inbox mb-4 text-4xl text-gray-400"></i>
                  <h3 class="mb-2 text-lg font-semibold text-gray-900">
                    No hay clientes disponibles
                  </h3>
                  <p class="text-sm text-gray-600">
                    Contacta al administrador para obtener acceso
                  </p>
                </div>
              }

              @else {
                <div class="space-y-4 pb-4 flex flex-col gap-x-1">
                  @for (client of store.clients(); track client.id) {
                    <app-client-card
                      [client]="client"
                      [isSelected]="store.selectedClient()?.id === client.id"
                      [clickable]="true"
                      (cardClick)="onClientSelect($event)" />
                  }
                </div>
              }
            </div>
          </div>
        }

        <!-- Step 2: Proyectos -->
        @if (store.currentStep() === SelectContextStep.SELECT_PROJECT) {
          <div class="flex h-full flex-col">
            <div class="flex-1 overflow-y-auto">

              <!-- Loading State -->
              @if (store.isLoadingProjects()) {
                <div class="space-y-4">
                  @for (i of [1, 2, 3]; track i) {
                    <div class="animate-pulse overflow-hidden rounded-xl border-2 border-gray-200 bg-white">
                      <div class="h-40 bg-gray-200"></div>
                      <div class="space-y-3 p-5">
                        <div class="h-4 w-3/4 rounded bg-gray-200"></div>
                        <div class="h-3 w-1/2 rounded bg-gray-200"></div>
                        <div class="flex gap-2">
                          <div class="h-6 w-20 rounded-full bg-gray-200"></div>
                          <div class="h-6 w-20 rounded-full bg-gray-200"></div>
                        </div>
                      </div>
                    </div>
                  }
                </div>
              }

              @else if (store.projectsError()) {
                <div class="rounded-xl border-2 border-red-200 bg-red-50 p-8 text-center">
                  <i class="pi pi-exclamation-circle mb-4 text-4xl text-red-500"></i>
                  <h3 class="mb-2 text-lg font-semibold text-red-900">
                    Error al cargar proyectos
                  </h3>
                  <p class="mb-4 text-sm text-red-700">
                    {{ store.projectsError() }}
                  </p>
                  <button
                    pRipple
                    type="button"
                    (click)="onRetryProjects()"
                    class="rounded-lg bg-red-500 px-4 py-2 text-sm font-semibold text-white transition-all hover:bg-red-600">
                    <i class="pi pi-refresh mr-2"></i>
                    Reintentar
                  </button>
                </div>
              }

              @else if (!store.hasProjects()) {
                <div class="rounded-xl border-2 border-dashed border-gray-300 bg-white p-8 text-center">
                  <i class="pi pi-inbox mb-4 text-4xl text-gray-400"></i>
                  <h3 class="mb-2 text-lg font-semibold text-gray-900">
                    No hay proyectos disponibles
                  </h3>
                  <p class="text-sm text-gray-600">
                    Este cliente no tiene proyectos asignados
                  </p>
                </div>
              }

              @else {
                <div class="space-y-4 pb-4 flex flex-col gap-x-1">
                  @for (project of store.projects(); track project.id) {
                    <app-project-card
                      [project]="project"
                      [isSelected]="store.selectedProject()?.id === project.id"
                      [clickable]="true"
                      (cardClick)="onProjectSelect($event)" />
                  }
                </div>
              }
            </div>
          </div>
        }

      </div>
    </div>
  </main>

  <!-- FOOTER FIXED -->
  <footer class="shrink-0 border-t border-gray-200 bg-white px-4 py-3 lg:px-8 lg:py-4">
    <div class="mx-auto flex max-w-7xl items-center justify-between">

      <!-- Desktop Info -->
      <div class="hidden lg:block">
        @if (store.selectedClient() && store.selectedProject()) {
          <p class="text-sm text-gray-600">
            <span class="font-semibold text-gray-900">{{ store.selectedClient()!.name }}</span>
            <i class="pi pi-angle-right mx-2 text-xs text-gray-400"></i>
            <span class="font-semibold text-gray-900">{{ store.selectedProject()!.name }}</span>
          </p>
        } @else if (store.selectedClient()) {
          <p class="text-sm text-gray-600">
            Cliente: <span class="font-semibold text-gray-900">{{ store.selectedClient()!.name }}</span>
          </p>
        } @else {
          <p class="text-sm text-gray-500">
            Selecciona un cliente y proyecto para continuar
          </p>
        }
      </div>

      <!-- Desktop Actions -->
      <div class="hidden gap-3 lg:flex">
        <button
          pRipple
          type="button"
          (click)="onCancel()"
          class="rounded-lg border border-gray-300 bg-white px-6 py-2.5 text-sm font-semibold text-gray-700 transition-all hover:bg-gray-50">
          Cancelar
        </button>

        <button
          pRipple
          type="button"
          [disabled]="!store.canFinish() || store.isLoading()"
          (click)="onFinish()"
          class="rounded-lg bg-sky-500 px-6 py-2.5 text-sm font-semibold text-white transition-all hover:bg-sky-600 disabled:cursor-not-allowed disabled:opacity-50">
          @if (store.isLoading()) {
            <i class="pi pi-spinner pi-spin mr-2"></i>
            Cargando...
          } @else {
            <i class="pi pi-check mr-2"></i>
            Confirmar
          }
        </button>
      </div>

      <!-- Mobile Actions -->
      <div class="flex w-full gap-3 lg:hidden">
        @if (store.currentStep() === SelectContextStep.SELECT_CLIENT) {
        <button
            pRipple
            type="button"
            (click)="onCancel()"
            class="flex-1 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-semibold text-gray-700 transition-all hover:bg-gray-50">
            Cancelar
          </button>
        }

        @if (store.currentStep() === SelectContextStep.SELECT_PROJECT) {
        <button
            pRipple
            type="button"
            (click)="onMobileBack()"
            class="rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-semibold text-gray-700 transition-all hover:bg-gray-50">
            <i class="pi pi-arrow-left"></i>
          </button>

          <button
            pRipple
            type="button"
            [disabled]="!store.canFinish() || store.isLoading()"
            (click)="onFinish()"
            class="flex-1 rounded-lg bg-sky-500 px-4 py-2.5 text-sm font-semibold text-white transition-all hover:bg-sky-600 disabled:cursor-not-allowed disabled:opacity-50">
            @if (store.isLoading()) {
              <i class="pi pi-spinner pi-spin mr-2"></i>
              Cargando...
            } @else {
              Confirmar
            }
          </button>
        }
      </div>
    </div>
  </footer>

</div>

<!-- Success Modal -->
@if (showSuccessModal) {
  <app-success-modal
    [(visible)]="showSuccessModal"
    (navigateToDashboard)="navigateToDashboard()"
    (navigateToCreateService)="navigateToCreateService()" />
}
