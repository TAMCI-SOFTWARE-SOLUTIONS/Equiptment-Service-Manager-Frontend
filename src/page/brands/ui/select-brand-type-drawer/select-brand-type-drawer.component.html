<p-drawer
  [(visible)]="visible"
  [position]="'right'"
  [modal]="true"
  [dismissible]="true"
  (onHide)="onClose()"
  [styleClass]="'!w-full sm:!w-[400px]'"
>
  <ng-template #header>
    <div class="flex items-center gap-3">
      @if (currentStep === 'enter-name') {
        <button
          type="button"
          (click)="goBackToSelectType()"
          class="flex h-9 w-9 items-center justify-center rounded-lg text-gray-600 transition-colors hover:bg-gray-100">
          <i class="pi pi-arrow-left text-sm"></i>
        </button>
      }

      <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-gradient-to-br from-sky-400 to-cyan-500">
        <i [class]="'text-sm text-white ' + (currentStep === 'select-type' ? 'pi pi-plus' : 'pi pi-tag')"></i>
      </div>
      <div>
        <h2 class="text-lg font-semibold text-gray-900">
          {{ currentStep === 'select-type' ? 'Nueva Marca' : 'Crear Marca' }}
        </h2>
        <p class="text-sm text-gray-500">
          {{ currentStep === 'select-type' ? 'Selecciona la categoría' : selectedTypeLabel }}
        </p>
      </div>
    </div>
  </ng-template>

  <!-- STEP 1: Select Type -->
  @if (currentStep === 'select-type') {
    <div class="space-y-4 py-2">
      @for (group of groupedTypes; track group.category) {
        <div>
          <div class="mb-2 flex items-center gap-2 px-1">
            <i [class]="'pi ' + group.categoryIcon + ' text-xs text-gray-400'"></i>
            <span class="text-xs font-semibold uppercase tracking-wide text-gray-500">
              {{ group.category }}
            </span>
          </div>

          <div class="space-y-2">
            @for (type of group.types; track type.enum) {
              <button
                type="button"
                (click)="selectType(type)"
                pRipple
                class="flex w-full items-center gap-3 rounded-lg border border-gray-200 bg-white p-3 text-left transition-all hover:border-sky-300 hover:bg-sky-50"
              >
                <div
                  [class]="
                    'flex h-10 w-10 shrink-0 items-center justify-center rounded-lg ' +
                    (type.color === 'cyan' ? 'bg-cyan-100' : 'bg-sky-100')
                  "
                >
                  <i
                    [class]="
                      'pi ' +
                      type.icon +
                      ' text-sm ' +
                      (type.color === 'cyan' ? 'text-cyan-600' : 'text-sky-600')
                    "
                  ></i>
                </div>
                <div class="flex-1">
                  <h3 class="font-medium text-gray-900">{{ type.label }}</h3>
                  <p class="text-xs text-gray-500">Agregar marca en {{ type.label }}</p>
                </div>
                <i class="pi pi-chevron-right text-sm text-gray-400"></i>
              </button>
            }
          </div>
        </div>
      }
    </div>
  }

  <!-- STEP 2: Enter Brand Name -->
  @if (currentStep === 'enter-name') {
    <div class="py-4">
      <div class="mb-4 flex items-center gap-2 rounded-lg border border-gray-200 bg-gray-50 p-3">
        <div
          [class]="
            'flex h-8 w-8 shrink-0 items-center justify-center rounded-lg ' +
            (selectedTypeColor === 'cyan' ? 'bg-cyan-100' : 'bg-sky-100')
          "
        >
          <i
            [class]="
              'pi ' +
              selectedTypeIcon +
              ' text-xs ' +
              (selectedTypeColor === 'cyan' ? 'text-cyan-600' : 'text-sky-600')
            "
          ></i>
        </div>
        <div>
          <p class="text-xs text-gray-500">Categoría</p>
          <p class="text-sm font-medium text-gray-900">{{ selectedTypeLabel }}</p>
        </div>
      </div>

      <div class="space-y-4">
        <div>
          <label for="brand-name-input" class="mb-2 block text-sm font-medium text-gray-900">
            Nombre de la marca
          </label>
          <input
            id="brand-name-input"
            type="text"
            [(ngModel)]="brandName"
            (keydown.enter)="onSave()"
            (keydown.escape)="onClose()"
            placeholder="Ej: Schneider Electric"
            class="block w-full rounded-lg border border-gray-300 px-3 py-2.5 text-sm text-gray-900 placeholder-gray-400 transition-all focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500/20"
            [class.border-rose-500]="brandName.trim().length > 0 && brandName.trim().length < 2"
          />

          @if (brandName.trim().length > 0 && brandName.trim().length < 2) {
            <p class="mt-1.5 flex items-center gap-1 text-xs text-rose-500">
              <i class="pi pi-exclamation-circle"></i>
              <span>El nombre debe tener al menos 2 caracteres</span>
            </p>
          }
          @if (brandName.trim().length > 50) {
            <p class="mt-1.5 flex items-center gap-1 text-xs text-rose-500">
              <i class="pi pi-exclamation-circle"></i>
              <span>El nombre no puede tener más de 50 caracteres</span>
            </p>
          }
          @if (isValid) {
            <p class="mt-1.5 flex items-center gap-1 text-xs text-gray-500">
              <i class="pi pi-info-circle"></i>
              <span>Presiona Enter para guardar o Esc para cancelar</span>
            </p>
          }
        </div>

        <div class="flex gap-2">
          <button
            type="button"
            (click)="onClose()"
            pRipple
            class="flex-1 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-50">
            Cancelar
          </button>
          <button
            type="button"
            (click)="onSave()"
            [disabled]="!isValid || isSaving"
            pRipple
            class="flex-1 rounded-lg bg-sky-500 px-4 py-2.5 text-sm font-semibold text-white transition-colors hover:bg-sky-600 disabled:cursor-not-allowed disabled:opacity-50">
            @if (isSaving) {
              <i class="pi pi-spin pi-spinner mr-2"></i>
            }
            {{ isSaving ? 'Guardando...' : 'Crear marca' }}
          </button>
        </div>
      </div>
    </div>
  }
</p-drawer>
