<div class="flex h-full flex-col bg-gray-50">

  <!-- Header -->
  <header class="shrink-0 border-b border-gray-200 bg-white px-4 py-4 lg:px-8">
    <div class="mx-auto max-w-7xl">

      <!-- Title & Actions -->
      <div class="flex items-center justify-between gap-4">
        <div class="flex items-center gap-3">
          <h1 class="text-xl font-bold text-gray-900 lg:text-2xl">
            Servicios Activos
          </h1>
          @if (store.hasServices() && !store.isLoading()) {
            <span class="flex h-6 items-center rounded-full bg-sky-100 px-2.5 py-0.5 text-xs font-medium text-sky-700">
              {{ store.statusCounts().all }}
            </span>
          }
        </div>

        <!-- Actions -->
        <div class="flex items-center gap-2">
          <!-- Refresh Button -->
          @if (!store.isLoading()) {
            <button
              type="button"
              (click)="onRefresh()"
              pRipple
              class="flex h-9 w-9 items-center justify-center rounded-lg border border-gray-300 bg-white text-gray-600 transition-colors hover:bg-gray-50 hover:text-gray-900 lg:h-10 lg:w-10">
              <i class="pi pi-refresh text-sm"></i>
            </button>
          }

          <!-- Create Button (Just Operator) -->
          @if (store.isOperator()) {
            <button
              type="button"
              (click)="onCreateNew()"
              [disabled]="store.isLoading()"
              pRipple
              class="inline-flex items-center gap-2 rounded-lg bg-sky-500 px-3 py-2 text-sm font-semibold text-white transition-colors hover:bg-sky-600 disabled:cursor-not-allowed disabled:opacity-50 lg:px-4">
              <i class="pi pi-plus text-sm"></i>
              <span class="hidden sm:inline">Nuevo Servicio</span>
              <span class="sm:hidden">Nuevo</span>
            </button>
          }
        </div>
      </div>

      <!-- Filters & Search -->
      @if (store.hasServices() && !store.isLoading()) {
        <div class="mt-4 space-y-3">

          <!-- Quick Filters -->
          <div class="flex flex-wrap gap-2">
            <button
              type="button"
              (click)="onStatusFilterChange('all')"
              [class.bg-sky-100]="store.statusFilter() === 'all'"
              [class.text-sky-700]="store.statusFilter() === 'all'"
              [class.font-semibold]="store.statusFilter() === 'all'"
              [class.bg-white]="store.statusFilter() !== 'all'"
              [class.text-gray-600]="store.statusFilter() !== 'all'"
              pRipple
              class="inline-flex items-center gap-1.5 rounded-lg border border-gray-300 px-3 py-1.5 text-sm transition-colors hover:bg-gray-50">
              Todos
              <span class="rounded-full bg-gray-200 px-1.5 py-0.5 text-xs">
                {{ store.statusCounts().all }}
              </span>
            </button>

            <button
              type="button"
              (click)="onStatusFilterChange(ServiceStatusEnum.CREATED)"
              [class.bg-gray-100]="store.statusFilter() === ServiceStatusEnum.CREATED"
              [class.text-gray-800]="store.statusFilter() === ServiceStatusEnum.CREATED"
              [class.font-semibold]="store.statusFilter() === ServiceStatusEnum.CREATED"
              [class.bg-white]="store.statusFilter() !== ServiceStatusEnum.CREATED"
              [class.text-gray-600]="store.statusFilter() !== ServiceStatusEnum.CREATED"
              pRipple
              class="inline-flex items-center gap-1.5 rounded-lg border border-gray-300 px-3 py-1.5 text-sm transition-colors hover:bg-gray-50">
              <i class="pi pi-circle text-xs"></i>
              Creados
              @if (store.statusCounts().created > 0) {
                <span class="rounded-full bg-gray-200 px-1.5 py-0.5 text-xs">
                  {{ store.statusCounts().created }}
                </span>
              }
            </button>

            <button
              type="button"
              (click)="onStatusFilterChange(ServiceStatusEnum.IN_PROGRESS)"
              [class.bg-blue-100]="store.statusFilter() === ServiceStatusEnum.IN_PROGRESS"
              [class.text-blue-800]="store.statusFilter() === ServiceStatusEnum.IN_PROGRESS"
              [class.font-semibold]="store.statusFilter() === ServiceStatusEnum.IN_PROGRESS"
              [class.bg-white]="store.statusFilter() !== ServiceStatusEnum.IN_PROGRESS"
              [class.text-gray-600]="store.statusFilter() !== ServiceStatusEnum.IN_PROGRESS"
              pRipple
              class="inline-flex items-center gap-1.5 rounded-lg border border-gray-300 px-3 py-1.5 text-sm transition-colors hover:bg-gray-50">
              <i class="pi pi-spin pi-spinner text-xs"></i>
              En Progreso
              @if (store.statusCounts().inProgress > 0) {
                <span class="rounded-full bg-blue-200 px-1.5 py-0.5 text-xs">
                  {{ store.statusCounts().inProgress }}
                </span>
              }
            </button>
          </div>

          <!-- Search Bar -->
          <div class="relative">
            <div class="pointer-events-none absolute inset-y-0 left-0 flex items-center pl-3">
              <i class="pi pi-search text-sm text-gray-400"></i>
            </div>
            <input
              type="text"
              [value]="store.searchQuery()"
              (input)="onSearchChange($any($event.target).value)"
              placeholder="{{store.searchQueryPlaceholder()}}"
              class="block w-full rounded-lg border border-gray-300 py-2 pl-9 pr-9 text-sm text-gray-900 placeholder-gray-400 transition-all focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500/20">

            @if (store.searchQuery()) {
              <button
                type="button"
                (click)="clearSearch()"
                class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-400 hover:text-gray-600">
                <i class="pi pi-times text-xs"></i>
              </button>
            }
          </div>

        </div>
      }

    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-1 overflow-y-auto px-4 py-6 lg:px-8">
    <div class="mx-auto max-w-7xl">

      <!-- Loading State -->
      @if (store.isLoading()) {
        <div class="space-y-3">
          @for (i of [1,2,3,4,5]; track i) {
            <div class="animate-pulse rounded-lg border border-gray-200 bg-white p-4">
              <div class="flex items-center justify-between">
                <div class="flex flex-1 items-center gap-4">
                  <div class="h-10 w-10 rounded-lg bg-gray-200"></div>
                  <div class="flex-1 space-y-2">
                    <div class="h-4 w-32 rounded bg-gray-200"></div>
                    <div class="h-3 w-48 rounded bg-gray-200"></div>
                  </div>
                </div>
                <div class="flex gap-2">
                  <div class="h-8 w-20 rounded bg-gray-200"></div>
                  <div class="h-8 w-20 rounded bg-gray-200"></div>
                </div>
              </div>
            </div>
          }
        </div>
      }

      @else if (!store.hasServices()) {
        <app-empty-state
          icon="pi-clock"
          iconBgClass="bg-gradient-to-br from-sky-100 to-cyan-100"
          iconColorClass="text-sky-600"
          title="No hay servicios activos"
          [description]="store.isOperator()
            ? 'No tienes servicios asignados actualmente.'
            : 'No hay servicios en progreso en este momento.'"
          [showButton]="store.isOperator()"
          buttonText="Crear Servicio"
          buttonIcon="pi-plus"
          (onAction)="onCreateNew()">
        </app-empty-state>
      }

      @else if (store.hasNoResults()) {
        <app-empty-state
          icon="pi-search"
          iconBgClass="bg-gradient-to-br from-gray-100 to-gray-200"
          iconColorClass="text-gray-500"
          title="No se encontraron resultados"
          [description]="'No hay servicios que coincidan con tu búsqueda o filtros.'"
          [showButton]="true"
          buttonText="Limpiar filtros"
          buttonIcon="pi-times"
          (onAction)="clearSearch(); onStatusFilterChange('all')">
        </app-empty-state>
      }

      @else {
        <div class="space-y-4">

          <!-- Desktop Table -->
          <div class="hidden overflow-hidden rounded-lg border border-gray-200 bg-white lg:block">
            <div class="overflow-x-auto">
              <table class="w-full">
                <thead class="bg-gray-50">
                <tr>
                  <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide text-gray-600">
                    Equipo
                  </th>
                  <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide text-gray-600">
                    Tipo Servicio
                  </th>
                  <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide text-gray-600">
                    Estado
                  </th>
                  <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide text-gray-600">
                    Supervisor
                  </th>
                  @if(!store.isOperator()) {
                    <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide text-gray-600">
                      Operador
                    </th>
                  }
                  <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide text-gray-600">
                    Inicio
                  </th>
                  <th class="px-4 py-3 text-left text-xs font-semibold uppercase tracking-wide text-gray-600">
                    Duración
                  </th>
                  <th class="px-4 py-3 text-right text-xs font-semibold uppercase tracking-wide text-gray-600">
                    Acciones
                  </th>
                </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                  @for (service of store.paginatedServices(); track service.id) {
                    <tr
                      class="group transition-colors hover:bg-gray-50">

                      <!-- Equipo -->
                      <td class="px-4 py-3">
                        <div class="flex items-center gap-2">
                          <div class="flex h-9 w-9 shrink-0 items-center justify-center rounded-lg bg-gradient-to-br from-sky-100 to-cyan-100">
                            <i [class]="'text-sm text-sky-700 ' + getEquipmentTypeIcon(service.equipmentType)"></i>
                          </div>
                          <div>
                            <p class="font-medium text-gray-900">{{ service.equipmentTag }}</p>
                            <p class="text-xs text-gray-500">{{ getEquipmentTypeLabel(service.equipmentType) }}</p>
                          </div>
                        </div>
                      </td>

                      <!-- Tipo Servicio -->
                      <td class="px-4 py-3">
                        <span class="text-sm text-gray-700">
                          {{ getServiceTypeLabel(service.type) }}
                        </span>
                      </td>

                      <!-- Estado -->
                      <td class="px-4 py-3">
                        <span [class]="getStatusBadgeClass(service.status)">
                          <i [class]="getStatusIcon(service.status)"></i>
                          {{ getStatusLabel(service.status) }}
                        </span>
                      </td>

                      <!-- Supervisor -->
                      <td class="px-4 py-3">
                        <span class="text-sm text-gray-700">
                          {{ service.supervisorName }}
                        </span>
                      </td>

                      @if(!store.isOperator()) {
                        <!-- Operador -->
                        <td class="px-4 py-3">
                          <span class="text-sm text-gray-700">
                            {{ service.operatorName }}
                          </span>
                        </td>
                      }

                      <!-- Inicio -->
                      <td class="px-4 py-3">
                        <span class="text-sm text-gray-600">
                          {{ formatDate(service.startedAt) }}
                        </span>
                      </td>

                      <!-- Duración -->
                      <td class="px-4 py-3">
                        <span class="text-sm text-gray-600">
                          {{ formatDuration(service.totalWorkDuration) }}
                        </span>
                      </td>

                      <!-- Acciones -->
                      <td class="px-4 py-3" (click)="$event.stopPropagation()">
                        <div class="flex justify-end">
                          <button
                            #menuButton
                            type="button"
                            (click)="menu.toggle($event)"
                            pRipple
                            class="flex h-8 w-8 items-center justify-center rounded-lg text-gray-600 transition-colors hover:bg-gray-100">
                            <i class="pi pi-ellipsis-v text-sm"></i>
                          </button>
                          <p-menu
                            #menu
                            [model]="getMenuItems(service)"
                            [popup]="true"
                            appendTo="body">
                          </p-menu>
                        </div>
                      </td>

                    </tr>
                  }
                </tbody>
              </table>
            </div>
          </div>

          <!-- Mobile Cards -->
          <div class="space-y-3 lg:hidden">
            @for (service of store.paginatedServices(); track service.id) {
              <div
                class="rounded-lg border border-gray-200 bg-white p-4 transition-all hover:shadow-sm">

                <!-- Header -->
                <div class="mb-3 flex items-start justify-between">
                  <div class="flex items-center gap-2">
                    <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-lg bg-gradient-to-br from-sky-100 to-cyan-100">
                      <i [class]="'text-sm text-sky-700 ' + getEquipmentTypeIcon(service.equipmentType)"></i>
                    </div>
                    <div>
                      <p class="font-semibold text-gray-900">{{ service.equipmentTag }}</p>
                      <p class="text-xs text-gray-500">{{ getEquipmentTypeLabel(service.equipmentType) }}</p>
                    </div>
                  </div>
                  <span [class]="getStatusBadgeClass(service.status)">
                    <i [class]="getStatusIcon(service.status)"></i>
                    {{ getStatusLabel(service.status) }}
                  </span>
                </div>

                <!-- Details -->
                <div class="mb-3 space-y-2 text-sm">
                  <div class="flex items-center justify-between">
                    <span class="text-gray-500">Tipo:</span>
                    <span class="font-medium text-gray-900">{{ getServiceTypeLabel(service.type) }}</span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span class="text-gray-500">Operador:</span>
                    <span class="font-medium text-gray-900">{{ service.operatorName }}</span>
                  </div>
                  <div class="flex items-center justify-between">
                    <span class="text-gray-500">Inicio:</span>
                    <span class="text-gray-600">{{ formatDate(service.startedAt) }}</span>
                  </div>
                </div>

                <!-- Actions -->
                <div class="flex gap-2 border-t border-gray-100 pt-3">
                  <button
                    type="button"
                    (click)="onServiceClick(service)"
                    pRipple
                    class="flex-1 rounded-lg bg-sky-500 px-3 py-2 text-sm font-semibold text-white transition-colors hover:bg-sky-600">
                    <i class="pi pi-eye mr-1.5 text-xs"></i>
                    {{ store.isOperator() ? 'Continuar' : 'Ver Detalles' }}
                  </button>

                  <button
                    #menuButtonMobile
                    type="button"
                    (click)="menuMobile.toggle($event)"
                    pRipple
                    class="flex h-10 w-10 items-center justify-center rounded-lg border border-gray-300 bg-white text-gray-600 transition-colors hover:bg-gray-50">
                    <i class="pi pi-ellipsis-v text-sm"></i>
                  </button>
                  <p-menu
                    #menuMobile
                    [model]="getMenuItems(service)"
                    [popup]="true"
                    appendTo="body">
                  </p-menu>
                </div>

              </div>
            }
          </div>

          <!-- Pagination -->
          <div class="rounded-lg border border-gray-200 bg-white">

            <!-- Desktop Pagination -->
            <div class="hidden items-center justify-between px-4 py-3 lg:flex">

              <!-- Left: Results info -->
              <div class="flex items-center gap-4">
                <div class="text-sm text-gray-600">
                  Mostrando
                  <span class="font-semibold text-gray-900">{{ store.paginationInfo().startIndex }}</span>
                  -
                  <span class="font-semibold text-gray-900">{{ store.paginationInfo().endIndex }}</span>
                  de
                  <span class="font-semibold text-gray-900">{{ store.paginationInfo().totalResults }}</span>
                  resultados
                </div>

                <!-- Page size selector -->
                <div class="flex items-center gap-2">
                  <label class="text-sm text-gray-600">Por página:</label>
                  <select
                    [value]="store.pageSize()"
                    (change)="store.setPageSize(+$any($event.target).value)"
                    class="rounded-lg border border-gray-300 px-2 py-1 text-sm text-gray-700 transition-colors hover:border-gray-400 focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500/20">
                    <option [value]="5">5</option>
                    <option [value]="10">10</option>
                    <option [value]="20">20</option>
                    <option [value]="50">50</option>
                  </select>
                </div>
              </div>

              <!-- Right: Page controls -->
              <div class="flex items-center gap-1">

                <!-- First page -->
                <button
                  type="button"
                  (click)="store.goToPage(1)"
                  [disabled]="!store.paginationInfo().hasPreviousPage"
                  pRipple
                  class="flex h-9 w-9 items-center justify-center rounded-lg border border-gray-300 bg-white text-gray-700 transition-colors hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-40">
                  <i class="pi pi-angle-double-left text-xs"></i>
                </button>

                <!-- Previous page -->
                <button
                  type="button"
                  (click)="store.previousPage()"
                  [disabled]="!store.paginationInfo().hasPreviousPage"
                  pRipple
                  class="flex h-9 w-9 items-center justify-center rounded-lg border border-gray-300 bg-white text-gray-700 transition-colors hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-40">
                  <i class="pi pi-chevron-left text-xs"></i>
                </button>

                <!-- Page numbers -->
                @for (page of store.visiblePages(); track $index) {
                  @if (page === 'ellipsis') {
                    <span class="flex h-9 w-9 items-center justify-center text-gray-400">
                        <i class="pi pi-ellipsis-h text-xs"></i>
                      </span>
                  } @else {
                    <button
                      type="button"
                      (click)="onPageClick(page)"
                      [class.bg-sky-500]="store.currentPage() === page"
                      [class.text-white]="store.currentPage() === page"
                      [class.font-semibold]="store.currentPage() === page"
                      [class.bg-white]="store.currentPage() !== page"
                      [class.text-gray-700]="store.currentPage() !== page"
                      [class.hover:bg-gray-50]="store.currentPage() !== page"
                      pRipple
                      class="flex h-9 w-9 items-center justify-center rounded-lg border border-gray-300 text-sm transition-colors">
                      {{ page }}
                    </button>
                  }
                }

                <!-- Next page -->
                <button
                  type="button"
                  (click)="store.nextPage()"
                  [disabled]="!store.paginationInfo().hasNextPage"
                  pRipple
                  class="flex h-9 w-9 items-center justify-center rounded-lg border border-gray-300 bg-white text-gray-700 transition-colors hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-40">
                  <i class="pi pi-chevron-right text-xs"></i>
                </button>

                <!-- Last page -->
                <button
                  type="button"
                  (click)="store.goToPage(store.totalPages())"
                  [disabled]="!store.paginationInfo().hasNextPage"
                  pRipple
                  class="flex h-9 w-9 items-center justify-center rounded-lg border border-gray-300 bg-white text-gray-700 transition-colors hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-40">
                  <i class="pi pi-angle-double-right text-xs"></i>
                </button>

              </div>
            </div>

            <!-- Mobile Pagination -->
            <div class="flex flex-col gap-3 px-4 py-3 lg:hidden">

              <!-- Results info -->
              <div class="text-center text-sm text-gray-600">
                {{ store.paginationInfo().startIndex }}-{{ store.paginationInfo().endIndex }}
                de {{ store.paginationInfo().totalResults }}
              </div>

              <!-- Controls -->
              <div class="flex items-center justify-between gap-2">
                <button
                  type="button"
                  (click)="store.previousPage()"
                  [disabled]="!store.paginationInfo().hasPreviousPage"
                  pRipple
                  class="flex flex-1 items-center justify-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-40">
                  <i class="pi pi-chevron-left text-xs"></i>
                  Anterior
                </button>

                <div class="flex items-center gap-1 text-sm font-medium text-gray-700">
                  {{ store.currentPage() }} / {{ store.totalPages() }}
                </div>

                <button
                  type="button"
                  (click)="store.nextPage()"
                  [disabled]="!store.paginationInfo().hasNextPage"
                  pRipple
                  class="flex flex-1 items-center justify-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 transition-colors hover:bg-gray-50 disabled:cursor-not-allowed disabled:opacity-40">
                  Siguiente
                  <i class="pi pi-chevron-right text-xs"></i>
                </button>
              </div>

              <!-- Page size selector mobile -->
              <div class="flex items-center justify-center gap-2">
                <label class="text-sm text-gray-600">Mostrar:</label>
                <select
                  [value]="store.pageSize()"
                  (change)="store.setPageSize(+$any($event.target).value)"
                  class="rounded-lg border border-gray-300 px-3 py-1.5 text-sm text-gray-700 transition-colors hover:border-gray-400 focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500/20">
                  <option [value]="5">5</option>
                  <option [value]="10">10</option>
                  <option [value]="20">20</option>
                  <option [value]="50">50</option>
                </select>
              </div>

            </div>

          </div>

        </div>
      }

    </div>
  </main>

</div>

<!-- Cancel Confirmation Modal -->
<app-confirmation-modal
  [show]="showCancelModal()"
  [title]="'¿Cancelar servicio?'"
  [message]="'Estás a punto de cancelar el servicio:'"
  [itemName]="serviceToCancelSignal()?.equipmentTag + ' - ' + getServiceTypeLabel(serviceToCancelSignal()?.type || ServiceTypeEnum.INSPECTION)"
  [warningText]="'Esta acción no se puede deshacer. El servicio quedará marcado como cancelado.'"
  [confirmText]="'Sí, cancelar servicio'"
  [isLoading]="isCancelling()"
  (onConfirm)="confirmCancel()"
  (onCancel)="closeCancelModal()">
</app-confirmation-modal>
