<div class="flex h-full flex-col bg-gray-50">

  <!-- Header Fijo -->
  <app-service-work-header
    [title]="getServiceTitle()"
    [currentStep]="store.currentStep()"
    [stepLabel]="getStepLabel(store.currentStep())"
    [progress]="getProgress()"
    [hasUnsavedChanges]="store.hasUnsavedChanges()"
    [isSaving]="store.isSavingInspection()"
    [isLoading]="store.isLoading()"
    [serviceStatus]="store.service()?.status || ServiceStatusEnum.CREATED"
    (onClose)="onExit()"
    (onStepClick)="onStepClick($event)"
    (onSave)="saveProgress()">
  </app-service-work-header>

  <!-- Main Content (Scrollable) -->
  <main class="flex-1 overflow-y-auto">
    <div class="mx-auto max-w-7xl px-4 py-6 lg:px-8">

      <!-- Loading State -->
      @if (store.isLoading() && !store.service()) {
        <div class="space-y-4">
          @for (i of [1,2,3]; track i) {
            <div class="animate-pulse rounded-lg border border-gray-200 bg-white p-6">
              <div class="h-4 w-1/3 rounded bg-gray-200"></div>
              <div class="mt-4 space-y-3">
                <div class="h-3 w-full rounded bg-gray-200"></div>
                <div class="h-3 w-2/3 rounded bg-gray-200"></div>
              </div>
            </div>
          }
        </div>
      }

      @else if (store.error()) {
        <app-empty-state
          icon="pi-exclamation-triangle"
          iconBgClass="bg-gradient-to-br from-rose-100 to-red-100"
          iconColorClass="text-rose-600"
          [title]="'Error al cargar el servicio'"
          [description]="store.error()!"
          [showButton]="true"
          buttonText="Reintentar"
          buttonIcon="pi-refresh"
          (onAction)="ngOnInit()">
        </app-empty-state>
      }

      @else {
        @switch (store.currentStep()) {

          <!-- STEP 1: Información -->
          @case (1) {
            <div class="space-y-6">

              <!-- Service Info Card -->
              @if (store.service() && store.supervisor();) {
                <app-service-info-card
                  [service]="store.service()!"
                  [supervisor]="store.supervisor()">
                </app-service-info-card>
              }

              <!-- Equipment Info Card -->
              @if (store.equipment() && store.service();) {
                <app-equipment-info-card
                  [equipment]="store.equipment()!"
                  [equipmentType]="store.service()!.equipmentType">
                </app-equipment-info-card>
              }

              <!-- Power Distribution List -->
              <app-power-distribution-list
                [powerDistributions]="store.powerDistributions()"
                [powerPanels]="store.powerPanels()">
              </app-power-distribution-list>
            </div>
          }

          <!-- STEP 2: Inspección -->
          @case (2) {
            <div class="space-y-6">

              <!-- Progress Banner -->
              @if (store.inspectionProgress(); as progress) {
                <app-inspection-progress-banner
                  [completed]="progress.completed"
                  [total]="progress.total"
                  [percentage]="progress.percentage">
                </app-inspection-progress-banner>
              }

              <!-- Unsaved Changes Warning -->
              @if (store.hasUnsavedChanges()) {
                <div class="rounded-xl border-l-4 border-amber-400 bg-amber-50 p-4">
                  <div class="flex items-center justify-between gap-3">
                    <div class="flex items-center gap-3">
                      <i class="pi pi-exclamation-triangle text-xl text-amber-600"></i>
                      <div>
                        <p class="font-semibold text-amber-900">Tienes cambios sin guardar</p>
                        <p class="text-sm text-amber-700">Haz clic en el botón "Guardar" del encabezado para guardar tus cambios</p>
                      </div>
                    </div>
                  </div>
                </div>
              }

              <!-- Inspection Tabs -->
              <app-inspection-tabs
                [tabConfigs]="store.tabConfigs()"
                [currentTab]="store.currentInspectableType()"
                [tabProgressMap]="store.tabProgress()"
                (onTabChange)="onInspectableTypeChange($event)">

                <!-- Items Loading -->
                @if (store.isLoadingItems()) {
                  <div class="space-y-4">
                    @for (i of [1,2,3]; track i) {
                      <div class="animate-pulse rounded-lg border border-gray-200 p-4">
                        <div class="h-4 w-1/4 rounded bg-gray-200"></div>
                        <div class="mt-3 flex gap-3">
                          <div class="h-10 flex-1 rounded bg-gray-200"></div>
                          <div class="h-10 flex-1 rounded bg-gray-200"></div>
                        </div>
                      </div>
                    }
                  </div>
                }

                @else if (store.currentTypeItems().length === 0) {
                  <app-empty-state
                    icon="pi-inbox"
                    iconBgClass="bg-gradient-to-br from-gray-100 to-gray-200"
                    iconColorClass="text-gray-500"
                    [title]="'No hay items en esta categoría'"
                    [description]="'No se encontraron items inspeccionables en esta sección'"
                    [showButton]="false">
                  </app-empty-state>
                }

                @else {
                  <div class="space-y-4">
                    @for (item of store.currentTypeItems(); track item.id) {
                      <app-inspection-item-form
                        [item]="item"
                        [conditionOptions]="getConditionOptions(item.type)"
                        [serviceType]="store.serviceType()"
                        (onConditionChange)="onConditionChange(item, $event)"
                        (onCriticalityChange)="onCriticalityChange(item, $event)"
                        (onObservationChange)="onObservationChange(item, $event)">
                      </app-inspection-item-form>
                    }
                  </div>
                }

              </app-inspection-tabs>

            </div>
          }

          <!-- STEP 3: Evidencias -->
          @case (3) {
            <div class="space-y-8">
              <app-evidence-section title="Videos del Servicio">
              <div class="grid grid-cols-1 gap-6 md:grid-cols-2">
                <app-video-uploader
                  label="Video de Inicio"
                  [file]="store.evidenceFiles().videoStart"
                  [isLoading]="store.uploadingStatus().videoStart"
                  [uploadType]="'videoStart'"
                  (onUpload)="onUploadVideo($event, 'videoStart')"
                  (onRemove)="onRemoveVideo('videoStart')"
                  (onPreview)="openPreviewModal($event)"
                  (onOpenCamera)="openCameraModal($event)">
                </app-video-uploader>

                <app-video-uploader
                  label="Video de Fin"
                  [file]="store.evidenceFiles().videoEnd"
                  [isLoading]="store.uploadingStatus().videoEnd"
                  [uploadType]="'videoEnd'"
                  (onUpload)="onUploadVideo($event, 'videoEnd')"
                  (onRemove)="onRemoveVideo('videoEnd')"
                  (onPreview)="openPreviewModal($event)"
                  (onOpenCamera)="openCameraModal($event)">
                </app-video-uploader>
              </div>
            </app-evidence-section>

              <app-evidence-section title="Reporte Fotográfico">
                <div class="grid grid-cols-1 gap-6 md:grid-cols-3">
                  <app-photo-uploader
                    label="Fotos de Inicio (1-3)"
                    [files]="store.evidenceFiles().startPhotos"
                    [isLoading]="store.uploadingStatus().startPhoto"
                    [maxFiles]="3"
                    [uploadType]="'startPhoto'"
                    (onUpload)="onUploadPhoto($event, 'startPhoto')"
                    (onRemove)="onRemovePhoto($event, 'startPhoto')"
                    (onPreview)="openPreviewModal($event)"
                    (onOpenCamera)="openCameraModal($event)">
                  </app-photo-uploader>

                  <app-photo-uploader
                    label="Fotos de Proceso (1-3)"
                    [files]="store.evidenceFiles().midPhotos"
                    [isLoading]="store.uploadingStatus().midPhoto"
                    [maxFiles]="3"
                    [uploadType]="'midPhoto'"
                    (onUpload)="onUploadPhoto($event, 'midPhoto')"
                    (onRemove)="onRemovePhoto($event, 'midPhoto')"
                    (onPreview)="openPreviewModal($event)"
                    (onOpenCamera)="openCameraModal($event)">
                  </app-photo-uploader>

                  <app-photo-uploader
                    label="Fotos de Fin (1-3)"
                    [files]="store.evidenceFiles().endPhotos"
                    [isLoading]="store.uploadingStatus().endPhoto"
                    [maxFiles]="3"
                    [uploadType]="'endPhoto'"
                    (onUpload)="onUploadPhoto($event, 'endPhoto')"
                    (onRemove)="onRemovePhoto($event, 'endPhoto')"
                    (onPreview)="openPreviewModal($event)"
                    (onOpenCamera)="openCameraModal($event)">
                  </app-photo-uploader>
                </div>
              </app-evidence-section>

              <app-evidence-section title="Reporte (PDF Opcional)">
                <app-report-uploader
                  label="Documento de Reporte"
                  [file]="store.evidenceFiles().report"
                  [isLoading]="store.uploadingStatus().report"
                  [uploadType]="'report'"
                  (onUpload)="onUploadReport($event)"
                  (onRemove)="onRemoveReport()"
                  (onPreview)="openPreviewModal($event)">
                </app-report-uploader>
              </app-evidence-section>
            </div>
          }

          <!-- STEP 4: Resumen -->
          @case (4) {
            <div class="space-y-6">
              <p class="text-2xl font-bold text-gray-900">Step 4: Resumen y Completar</p>
              <p class="text-gray-600">Contenido temporal - implementaremos en Fase 6</p>
            </div>
          }

        }
      }

    </div>
  </main>

  <!-- Footer -->
  <app-service-work-footer
    [currentStep]="store.currentStep()"
    [stepLabel]="getStepLabel(store.currentStep())"
    [isLastStep]="store.currentStep() === 4"
    [canGoPrevious]="store.currentStep() > 1"
    [canGoNext]="true"
    [canComplete]="store.canCompleteService()"
    [isLoading]="store.isStartingService() || store.isCompletingService()"
    [nextButtonLabel]="getNextButtonLabel()"
    [showStartButton]="shouldShowStartButton()"
    (onPrevious)="onBack()"
    (onNext)="onNextOrStart()"
    (onComplete)="onCompleteServiceClick()">
  </app-service-work-footer>

</div>

<!-- Modals (sin cambios) -->
<app-confirmation-modal
  [show]="showStartModal()"
  [title]="'¿Comenzar servicio?'"
  [message]="'Estás a punto de iniciar el servicio. Una vez iniciado, podrás comenzar con las inspecciones.'"
  [confirmText]="'Sí, comenzar'"
  [isLoading]="store.isStartingService()"
  (onConfirm)="confirmStartService()"
  (onCancel)="cancelStartService()">
</app-confirmation-modal>

<app-confirmation-modal
  [show]="showCompleteModal()"
  [title]="'¿Completar servicio?'"
  [message]="'Estás a punto de completar el servicio. Verifica que toda la información esté correcta.'"
  [confirmText]="'Sí, completar'"
  [isLoading]="store.isCompletingService()"
  (onConfirm)="confirmCompleteService()"
  (onCancel)="cancelCompleteService()">
</app-confirmation-modal>

<app-confirmation-modal
  [show]="showExitModal()"
  [title]="'¿Salir del servicio?'"
  [message]="'Tienes cambios sin guardar. Se guardarán automáticamente antes de salir.'"
  [confirmText]="'Guardar y salir'"
  [isLoading]="store.isSavingInspection()"
  (onConfirm)="confirmExit()"
  (onCancel)="cancelExit()">
</app-confirmation-modal>


<p-dialog
  [header]="previewFile()?.originalName"
  [(visible)]="showPreviewModal"
  [modal]="true"
  [style]="{ width: '90vw' }"
  [contentStyle]="{ height: '90vh' }"
  [draggable]="false"
  [resizable]="false"
  (onHide)="closePreviewModal()">

  <div class="w-full h-full">

    @if (isPreviewLoading()) {
      <div class="flex h-full flex-col items-center justify-center gap-4"> <p-progressSpinner class="w-16 h-16" strokeWidth="4"></p-progressSpinner>
        <span class="text-lg text-gray-600">
          Cargando previsualización... Esto puede tardar varios minutos.
        </span>
      </div>
    }

    @if (previewContentUrl() && !isPreviewLoading()) {

      @if (isPreviewImage()) {
        <img [src]="previewContentUrl()" alt="Previsualización" class="max-w-full max-h-full object-contain">
      }

      @if (isPreviewVideo()) {
        <video [src]="previewContentUrl()" controls autoplay class="max-w-full max-h-full"></video>
      }

      @if (isPreviewPdf()) {
        <ngx-extended-pdf-viewer
          [src]="previewContentUrl()"
          [height]="'100%'">
        </ngx-extended-pdf-viewer>
      }
    }
  </div>
</p-dialog>

<p-dialog
  [header]="isPhotoCapture() ? 'Tomar Foto' : 'Grabar Video'"
  [(visible)]="showCameraModal"
  (onHide)="closeCameraModal()">

  @if (showCameraModal()) {
    <div class="flex flex-col items-center">

      @if (capturedImagePreview() || capturedVideoPreviewUrl()) {

        @if (capturedImagePreview()) {
          <img [src]="capturedImagePreview()" alt="Captura" class="w-full h-auto">
        }

        @if (capturedVideoPreviewUrl()) {
          <video [src]="capturedVideoPreviewUrl()" controls autoplay class="w-full h-auto"></video>
        }

        <div class="mt-4 flex gap-3">
          <button pButton type="button" (click)="confirmCapture()">
            <i class="pi pi-check" pButtonIcon></i>
            <span pButtonLabel>Guardar</span>
          </button>
          <button pButton type="button" class="p-button-danger p-button-outlined" (click)="discardCapture()">
            <i class="pi pi-times" pButtonIcon></i>
            <span pButtonLabel>Descartar</span>
          </button>
        </div>

      } @else {

        @if (isPhotoCapture()) {
          <webcam
            [trigger]="cameraTrigger.asObservable()"
            (imageCapture)="handleImageCapture($event)"
            (initError)="handleInitError($event)"
            [width]="640"
            [height]="480"
            [videoOptions]="{ facingMode: 'environment' }"
            [imageType]="'image/jpeg'"
            [imageQuality]="0.92">
          </webcam>
        }

        @if (!isPhotoCapture()) {
          <video #videoPlayer autoplay muted class="w-full h-auto bg-black"></video>
        }

        <div class="mt-4">
          @if (isPhotoCapture()) {
            <button pButton type="button" (click)="triggerSnapshot()">
              <i class="pi pi-camera" pButtonIcon></i>
              <span pButtonLabel>Tomar Foto</span>
            </button>
          } @else {
            @if (!isRecording()) {
              <button pButton type="button" class="p-button-danger" (click)="startRecording()">
                <i class="pi pi-video" pButtonIcon></i>
                <span pButtonLabel>Iniciar Grabación</span>
              </button>
            } @else {
              <button pButton type="button" (click)="stopRecording()">
                <i class="pi pi-stop-circle" pButtonIcon></i>
                <span pButtonLabel>Detener Grabación</span>
              </button>
            }
          }
        </div>
      }

    </div>
  }
</p-dialog>
