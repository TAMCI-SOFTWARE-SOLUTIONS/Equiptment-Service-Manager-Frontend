<!-- src/app/pages/service-details/ui/service-details/service-details.page.html -->

<div class="flex h-full flex-col bg-gray-50">

  <!-- Toast -->
  <p-toast position="top-right" />

  <!-- Header (Sticky) -->
  <header class="sticky top-0 z-10 border-b border-gray-200 bg-white shadow-sm">
    <div class="mx-auto max-w-7xl px-4 py-4 lg:px-8">
      <div class="flex items-center gap-4">

        <!-- Back Button -->
        <button
          (click)="onBack()"
          class="flex h-10 w-10 items-center justify-center rounded-lg border border-gray-200 text-gray-600 transition-all hover:bg-gray-50">
          <i class="pi pi-arrow-left"></i>
        </button>

        <!-- Title -->
        <div class="flex-1">
          <h1 class="text-xl font-bold text-gray-900">Detalles del Servicio</h1>
          <p class="text-sm text-gray-600">
            @if (store.service()) {
              ID: {{ store.service()!.id }}
            }
          </p>
        </div>

        <!-- Loading Indicator -->
        @if (store.isLoading()) {
          <div class="flex items-center gap-2 text-sm text-gray-600">
            <i class="pi pi-spin pi-spinner"></i>
            <span>Cargando...</span>
          </div>
        }

      </div>
    </div>
  </header>

  <!-- Main Content (Scrollable) -->
  <main class="flex-1 overflow-y-auto">
    <div class="mx-auto max-w-7xl px-4 py-6 lg:px-8">

      <!-- Loading State -->
      @if (store.isLoadingService() && !store.service()) {
        <div class="space-y-6">
          @for (i of [1,2,3,4]; track i) {
            <div class="animate-pulse rounded-2xl border border-gray-200 bg-white p-6">
              <div class="h-4 w-1/3 rounded bg-gray-200"></div>
              <div class="mt-4 space-y-3">
                <div class="h-3 w-full rounded bg-gray-200"></div>
                <div class="h-3 w-2/3 rounded bg-gray-200"></div>
              </div>
            </div>
          }
        </div>
      }

      @else if (store.error()) {
        <app-empty-state
          icon="pi-exclamation-triangle"
          iconBgClass="bg-gradient-to-br from-rose-100 to-red-100"
          iconColorClass="text-rose-600"
          [title]="'Error al cargar el servicio'"
          [description]="store.error()!"
          [showButton]="true"
          buttonText="Volver a intentar"
          buttonIcon="pi-refresh"
          (onAction)="ngOnInit()">
        </app-empty-state>
      }

      @else if (store.service() && store.equipment() && store.supervisor() && store.operator()) {
        <div class="space-y-6">

          <!-- Hero Card -->
          <app-details-hero-card
            [service]="store.service()!"
            [supervisor]="store.supervisor()!"
            [equipment]="store.equipment()!"
            [operatorFullName]="store.operatorFullName()">
          </app-details-hero-card>

          <!-- Stats Cards -->
          <app-details-stats-cards
            [totalItems]="store.totalItems()"
            [totalChanges]="store.totalChanges()"
            [totalImproved]="store.totalImproved()"
            [totalDegraded]="store.totalDegraded()">
          </app-details-stats-cards>

          <!-- Inspections Accordion -->
          <div class="rounded-2xl border border-gray-200 bg-white p-6">
            @if (store.isLoadingInspections()) {
              <div class="space-y-4">
                @for (i of [1,2,3]; track i) {
                  <div class="animate-pulse rounded-lg bg-gray-100 p-4">
                    <div class="h-4 w-1/4 rounded bg-gray-200"></div>
                    <div class="mt-3 h-3 w-full rounded bg-gray-200"></div>
                  </div>
                }
              </div>
            } @else {
              <app-inspections-accordion
                [allItems]="store.itemInspections()"
                [filteredItems]="store.filteredItems()"
                [itemsByCategory]="store.itemsByCategory()"
                [currentFilter]="store.selectedFilter()"
                [openCategories]="store.openCategories()"
                (onFilterChange)="onFilterChange($event)"
                (onCategoryToggle)="onCategoryToggle($event)"
                (onToggleAll)="onToggleAllCategories()">
              </app-inspections-accordion>
            }
          </div>

          <!-- Evidence Accordion -->
          <div class="rounded-2xl border border-gray-200 bg-white p-6">
            <h2 class="mb-6 flex items-center gap-3 text-xl font-bold text-gray-900">
              <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-purple-100">
                <i class="pi pi-images text-2xl text-purple-600"></i>
              </div>
              <span>Evidencias</span>
            </h2>

            @if (store.isLoadingEvidence()) {
              <div class="space-y-4">
                @for (i of [1,2]; track i) {
                  <div class="animate-pulse rounded-lg bg-gray-100 p-4">
                    <div class="h-4 w-1/4 rounded bg-gray-200"></div>
                    <div class="mt-3 h-20 w-full rounded bg-gray-200"></div>
                  </div>
                }
              </div>
            } @else {
              <app-evidence-accordion
                [service]="store.service()!"
                [evidenceFiles]="store.evidenceFiles()"
                [userRole]="userRole()"
                [isUploadingReport]="store.isUploadingReport()"
                (onVideoPreview)="onVideoPreview($event)"
                (onPhotoClick)="onPhotoClick($event)"
                (onReportUpload)="onReportUpload($event)"
                (onReportRemove)="onReportRemove()">
              </app-evidence-accordion>
            }
          </div>

          <!-- Location Accordion -->
          <div class="rounded-2xl border border-gray-200 bg-white p-6">
            <h2 class="mb-6 flex items-center gap-3 text-xl font-bold text-gray-900">
              <div class="flex h-12 w-12 items-center justify-center rounded-xl bg-emerald-100">
                <i class="pi pi-map-marker text-2xl text-emerald-600"></i>
              </div>
              <span>Ubicación y Distribución</span>
            </h2>

            <app-location-accordion
              [equipment]="store.equipment()!"
              [equipmentType]="store.service()!.equipmentType"
              [powerDistributions]="store.powerDistributions()"
              [powerPanels]="store.powerPanels()">
            </app-location-accordion>
          </div>

        </div>
      }

    </div>
  </main>

</div>
