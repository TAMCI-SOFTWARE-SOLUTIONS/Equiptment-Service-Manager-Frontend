<div class="space-y-6">

  <div class="text-center">
    <h2 class="text-xl font-semibold text-gray-900">
      Confirmar Servicio
    </h2>
    <p class="mt-2 text-sm text-gray-600">
      Revisa los detalles y asigna un supervisor
    </p>
  </div>

  @if (store.selectedEquipment()) {
    <div class="grid gap-6 lg:grid-cols-2">

      <!-- Card: Resumen del Servicio -->
      <div class="rounded-xl border border-gray-200 bg-white shadow-sm">
        <div class="border-b border-gray-100 p-6">
          <div class="flex items-center gap-3">
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-sky-100">
              <i class="pi pi-file-check text-lg text-sky-600"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-900">
              Resumen del Servicio
            </h3>
          </div>
        </div>

        <div class="p-6">
          <dl class="space-y-4">
            <!-- Tipo de Servicio -->
            <div>
              <dt class="text-xs font-medium uppercase tracking-wider text-gray-500">
                Tipo de Servicio
              </dt>
              <dd class="mt-1 text-sm font-semibold text-gray-900">
                {{ store.serviceTypeLabel() }}
              </dd>
            </div>

            <!-- Equipo -->
            <div>
              <dt class="text-xs font-medium uppercase tracking-wider text-gray-500">
                {{ store.projectAllowedEquipmentTypeLabel() }} Seleccionado
              </dt>
              <dd class="mt-1">
                <div class="flex items-center gap-2">
                  <span class="text-xl">
                    {{ store.formData().selectedEquipmentType === EquipmentTypeEnum.CABINET ? '📦' : '📋' }}
                  </span>
                  <span class="font-semibold text-gray-900">
                    {{ store.selectedEquipment()?.tag }}
                  </span>
                </div>
              </dd>
            </div>
          </dl>
        </div>
      </div>

      <!-- Card: Información del Equipo -->
      <div class="rounded-xl border border-gray-200 bg-white shadow-sm">
        <div class="border-b border-gray-100 p-6">
          <div class="flex items-center gap-3">
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-sky-100">
              <i class="pi pi-box text-lg text-sky-600"></i>
            </div>
            <h3 class="text-lg font-semibold text-gray-900">
              Información del {{ store.projectAllowedEquipmentTypeLabel() }}
            </h3>
          </div>
        </div>

        <div class="p-6">
          <dl class="space-y-4">
            <!-- Tag -->
            <div>
              <dt class="text-xs font-medium uppercase tracking-wider text-gray-500">
                Tag
              </dt>
              <dd class="mt-1 text-base font-semibold text-gray-900">
                {{ store.selectedEquipment()?.tag }}
              </dd>
            </div>

            <!-- Tipo -->
            <div>
              <dt class="text-xs font-medium uppercase tracking-wider text-gray-500">
                Tipo de {{ store.projectAllowedEquipmentTypeLabel() }}
              </dt>
              <dd class="mt-1 text-sm text-gray-900">
                {{ getEquipmentTypeName() }}
              </dd>
            </div>

            <!-- Estado -->
            <div>
              <dt class="text-xs font-medium uppercase tracking-wider text-gray-500">
                Estado Actual
              </dt>
              <dd class="mt-1">
                <span class="inline-flex items-center gap-1.5 rounded-full px-3 py-1 text-sm font-medium"
                      [ngClass]="getStatusClasses(store.selectedEquipment()?.status)">
                  <span class="h-1.5 w-1.5 rounded-full"
                        [ngClass]="getStatusIndicatorClass(store.selectedEquipment()?.status)"></span>
                  {{ getStatusLabel(store.selectedEquipment()?.status) }}
                </span>
              </dd>
            </div>

            <!-- Protocolo de Comunicación -->
            @if (store.selectedEquipment()?.communicationProtocol) {
              <div>
                <dt class="text-xs font-medium uppercase tracking-wider text-gray-500">
                  Protocolo de Comunicación
                </dt>
                <dd class="mt-1 text-sm text-gray-900">
                  {{ store.selectedEquipment()?.communicationProtocol }}
                </dd>
              </div>
            }

            <!-- Fechas -->
            @if (store.selectedEquipment()?.createdAt) {
              <div>
                <dt class="text-xs font-medium uppercase tracking-wider text-gray-500">
                  Fecha de Creación
                </dt>
                <dd class="mt-1 text-sm text-gray-900">
                  {{ store.selectedEquipment()?.createdAt | date:'medium' }}
                </dd>
              </div>
            }

            <!--TODO: Change this date-->
            @if (store.selectedEquipment()?.lastInspectionAt) {
              <div>
                <dt class="text-xs font-medium uppercase tracking-wider text-gray-500">
                  Última Revisión
                </dt>
                <dd class="mt-1 text-sm text-gray-900">
                  {{ store.selectedEquipment()?.lastInspectionAt | date:'medium' }}
                </dd>
              </div>
            } @else {
              <div class="rounded-lg border border-amber-200 bg-amber-50 p-3">
                <div class="flex items-start gap-2">
                  <i class="pi pi-exclamation-triangle mt-0.5 text-sm text-amber-600"></i>
                  <p class="text-xs text-amber-900">
                    Sin registro de última revisión
                  </p>
                </div>
              </div>
            }
          </dl>
        </div>
      </div>

      <!-- Card: Paneles de Distribución (NUEVO) -->
      <div class="rounded-xl border border-gray-200 bg-white shadow-sm lg:col-span-2">
        <div class="border-b border-gray-100 p-6">
          <div class="flex items-center gap-3">
            <div class="flex h-10 w-10 items-center justify-center rounded-lg bg-sky-100">
              <i class="pi pi-bolt text-lg text-sky-600"></i>
            </div>
            <div class="flex-1">
              <h3 class="text-lg font-semibold text-gray-900">
                Paneles de Distribución
              </h3>
              @if (store.hasPowerAssignments() && !store.isLoadingPowerAssignments()) {
                <p class="mt-0.5 text-xs text-gray-600">
                  {{ store.powerAssignments().length }} {{ store.powerAssignments().length === 1 ? 'panel asignado' : 'paneles asignados' }}
                </p>
              }
            </div>
          </div>
        </div>

        <div class="p-6">

          <!-- Loading State -->
          @if (store.isLoadingPowerAssignments()) {
            <div class="space-y-3">
              @for (i of [1,2]; track i) {
                <div class="rounded-lg border border-gray-200 bg-white p-4">
                  <div class="flex items-start gap-4">
                    <div class="h-12 w-12 animate-pulse rounded-lg bg-gray-200"></div>
                    <div class="flex-1 space-y-2">
                      <div class="h-4 w-2/3 animate-pulse rounded bg-gray-200"></div>
                      <div class="h-3 w-1/2 animate-pulse rounded bg-gray-200"></div>
                    </div>
                  </div>
                </div>
              }
            </div>
          }
          @else if (store.hasPowerAssignments()) {
            <!-- Assignments List -->
            <div class="space-y-3">
              @for (assignmentWithPanel of store.powerAssignments(); track assignmentWithPanel.assignment.id) {
                <article class="rounded-lg border border-gray-200 bg-white p-4 transition-all hover:border-sky-300 hover:bg-sky-50/30">

                  <div class="flex items-start gap-4">
                    <!-- Icon -->
                    <div class="flex h-12 w-12 shrink-0 items-center justify-center rounded-lg bg-gradient-to-br from-sky-100 to-cyan-100">
                      <i class="pi pi-bolt text-xl text-sky-600"></i>
                    </div>

                    <!-- Info -->
                    <div class="min-w-0 flex-1">
                      @if (assignmentWithPanel.isLoadingPanel) {
                        <!-- Loading panel info -->
                        <div class="space-y-2">
                          <div class="h-4 w-32 animate-pulse rounded bg-gray-200"></div>
                          <div class="h-3 w-24 animate-pulse rounded bg-gray-200"></div>
                        </div>
                      } @else if (assignmentWithPanel.panel) {
                        <!-- Panel Info -->
                        <div class="flex items-start gap-2">
                          <div class="flex-1">
                            <div class="flex items-center gap-2">
                              <h4 class="font-mono text-base font-semibold text-gray-900">
                                {{ assignmentWithPanel.panel.code }}
                              </h4>
                              <span
                                class="shrink-0 rounded-full px-2.5 py-0.5 text-xs font-semibold"
                                [ngClass]="getPanelTypeBadgeClass(assignmentWithPanel.panel.type)">
                                {{ assignmentWithPanel.panel.type }}
                              </span>
                            </div>
                            <p class="mt-1 text-xs text-gray-600">
                              {{ getPanelTypeDescription(assignmentWithPanel.panel.type) }}
                            </p>
                          </div>
                        </div>

                        <!-- Circuits -->
                        <div class="mt-3 rounded-lg border border-sky-200 bg-sky-50 p-3">
                          <div class="flex items-start gap-2">
                            <i class="pi pi-sitemap mt-0.5 text-sm text-sky-600"></i>
                            <div class="flex-1">
                              <p class="text-xs font-medium text-sky-900">
                                Circuitos Asignados
                              </p>

                              <!-- Circuitos como badges -->
                              <div class="mt-2 flex flex-wrap gap-1.5">
                                @for (circuit of assignmentWithPanel.assignment.circuitAssignments; track $index) {
                                  <span class="inline-flex items-center rounded-full bg-sky-600 px-2.5 py-0.5 font-mono text-xs font-semibold text-white">
                                    {{ circuit }}
                                  </span>
                                }
                              </div>

                              <p class="mt-2 text-xs text-sky-600">
                                Total: {{ assignmentWithPanel.assignment.circuitAssignments.length }} circuitos
                              </p>
                            </div>
                          </div>
                        </div>
                      } @else {
                        <!-- Error loading panel -->
                        <div class="rounded-lg border border-amber-200 bg-amber-50 p-3">
                          <div class="flex items-start gap-2">
                            <i class="pi pi-exclamation-triangle text-sm text-amber-600"></i>
                            <p class="text-xs text-amber-800">
                              Error al cargar información del panel
                            </p>
                          </div>
                        </div>
                      }
                    </div>
                  </div>

                </article>
              }
            </div>
          }
          @else {
            <!-- No Power Assignments - Interruptor Principal -->
            <div class="rounded-lg border-2 border-dashed border-gray-300 bg-gray-50 p-6 text-center">
              <div class="mx-auto flex h-16 w-16 items-center justify-center rounded-full bg-gradient-to-br from-gray-100 to-gray-200">
                <i class="pi pi-bolt text-3xl text-gray-500"></i>
              </div>
              <h4 class="mt-4 text-sm font-semibold text-gray-900">
                Interruptor Principal
              </h4>
              <p class="mt-2 text-xs text-gray-600">
                Este {{ store.projectAllowedEquipmentTypeLabel().toLowerCase() }} está conectado directamente al interruptor principal
              </p>
              <div class="mt-4 inline-flex items-center gap-2 rounded-full bg-gray-200 px-4 py-2 text-xs font-medium text-gray-700">
                <i class="pi pi-info-circle text-xs"></i>
                <span>Sin paneles de distribución asignados</span>
              </div>
            </div>
          }

          <!-- Error State -->
          @if (store.powerAssignmentsError()) {
            <div class="mt-4 flex items-start gap-3 rounded-lg border border-red-200 bg-red-50 p-3">
              <i class="pi pi-exclamation-circle mt-0.5 text-base text-red-600"></i>
              <p class="text-sm font-medium text-red-800">
                {{ store.powerAssignmentsError() }}
              </p>
            </div>
          }

        </div>
      </div>

      <!-- Supervisor -->
      <div class="rounded-lg border border-gray-200 bg-white p-4">
        <label class="mb-2 block text-sm font-medium text-gray-700">
          Supervisor Responsable
          <span class="text-rose-500">*</span>
        </label>

        <!-- Loading State -->
        @if (store.isLoadingSupervisors()) {
          <div class="flex items-center gap-2 rounded-lg border border-gray-300 bg-gray-50 px-4 py-2.5 text-gray-500">
            <i class="pi pi-spinner pi-spin text-sm"></i>
            <span class="text-sm">Cargando supervisores...</span>
          </div>
        }

        @else if (store.supervisors().length > 0) {
          <p-select
            [options]="getSupervisorOptions()"
            [(ngModel)]="store.supervisorId"
            (onChange)="onSupervisorChange($event.value)"
            placeholder="Seleccionar supervisor"
            [filter]="true"
            filterPlaceholder="Buscar supervisor..."
            [showClear]="false"
            optionLabel="label"
            optionValue="value"
            appendTo="body"
            [style]="{'width': '100%'}"
            class="w-full">
          </p-select>

          <!-- Validation Error -->
          @if (!store.hasSupervisorSelected()) {
            <p class="mt-2 text-sm text-gray-500">
              <i class="pi pi-info-circle mr-1 text-xs"></i>
              Selecciona el supervisor responsable del servicio
            </p>
          }
        }
        @else {
          <div class="rounded-lg border border-amber-200 bg-amber-50 p-3">
            <div class="flex items-start gap-2">
              <i class="pi pi-exclamation-triangle mt-0.5 text-sm text-amber-600"></i>
              <div>
                <p class="text-sm font-medium text-amber-900">
                  No hay supervisores disponibles
                </p>
                <p class="mt-1 text-xs text-amber-700">
                  Debes crear al menos un supervisor antes de continuar.
                </p>
              </div>
            </div>
          </div>
        }
      </div>

    </div>
  } @else {
    <!-- Error state: No equipment selected -->
    <div class="flex flex-col items-center justify-center rounded-xl border border-red-200 bg-red-50 py-16 text-center">
      <i class="pi pi-exclamation-triangle mb-4 text-5xl text-red-400"></i>
      <h3 class="text-lg font-semibold text-red-900">
        No hay {{ store.projectAllowedEquipmentTypeLabel().toLowerCase() }} seleccionado
      </h3>
      <p class="mt-2 text-sm text-red-700">
        Por favor, regresa al paso anterior y selecciona un {{ store.projectAllowedEquipmentTypeLabel().toLowerCase() }}.
      </p>
    </div>
  }

</div>
