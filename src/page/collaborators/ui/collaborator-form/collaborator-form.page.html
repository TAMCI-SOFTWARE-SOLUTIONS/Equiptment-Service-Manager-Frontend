<div class="flex h-full flex-col bg-gray-50">

  <!-- Header -->
  <header class="shrink-0 border-b border-gray-200 bg-white px-4 py-4 lg:px-8">
    <div class="mx-auto max-w-4xl">
      <div class="flex items-center justify-between gap-4">
        <div class="flex-1">
          <h1 class="text-xl font-bold text-gray-900 lg:text-2xl">
            Nuevo Colaborador
          </h1>
          <p class="mt-1 text-sm text-gray-600">
            Paso {{ store.currentStep() }} de {{ store.totalSteps() }}
          </p>
        </div>

        <button
          pRipple
          type="button"
          (click)="onCancel()"
          [disabled]="store.isSubmitting()"
          class="flex h-10 w-10 items-center justify-center rounded-lg border border-gray-300 bg-white text-gray-700 transition-all hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-1 disabled:cursor-not-allowed disabled:opacity-50">
          <i class="pi pi-times text-base"></i>
        </button>
      </div>

      <!-- Progress Bar -->
      <div class="mt-4 h-2 overflow-hidden rounded-full bg-gray-200">
        <div
          class="h-full bg-gradient-to-r from-sky-500 to-cyan-500 transition-all duration-500 ease-out"
          [style.width.%]="store.progress()">
        </div>
      </div>
    </div>
  </header>

  <!-- Content -->
  <main class="flex-1 overflow-auto px-4 py-6 lg:px-8">
    <div class="mx-auto max-w-4xl">

      <!-- Error Global -->
      @if (store.error()) {
        <div class="mb-6 flex items-start gap-3 rounded-lg border border-red-200 bg-red-50 p-4 animate-in fade-in slide-in-from-top-2 duration-300">
          <i class="pi pi-exclamation-circle mt-0.5 text-lg text-red-600"></i>
          <div class="flex-1">
            <p class="font-medium text-red-800">Error</p>
            <p class="mt-1 text-sm text-red-700">{{ store.error() }}</p>
          </div>
          <button
            type="button"
            (click)="store.clearError()"
            class="rounded-md p-1.5 text-red-600 transition-colors hover:bg-red-100">
            <i class="pi pi-times text-sm"></i>
          </button>
        </div>
      }

      <div class="grid gap-6 lg:grid-cols-12">

        <!-- Stepper Sidebar (Desktop) -->
        <aside class="hidden lg:col-span-3 lg:block">
          <div class="sticky top-6 space-y-2">
            @for (step of [1, 2]; track step) {
              <button
                type="button"
                (click)="onGoToStep(step)"
                [disabled]="step > 1 && !isStepCompleted(1)"
                class="flex w-full items-center gap-3 rounded-lg p-3 text-left transition-all disabled:cursor-not-allowed disabled:opacity-50"
                [class.bg-sky-50]="isStepActive(step)"
                [class.border-2]="isStepActive(step)"
                [class.border-sky-500]="isStepActive(step)"
                [class.hover:bg-gray-50]="!isStepActive(step)">

                <div class="flex h-10 w-10 shrink-0 items-center justify-center rounded-full transition-all"
                     [class.bg-sky-500]="isStepActive(step)"
                     [class.text-white]="isStepActive(step)"
                     [class.bg-sky-100]="!isStepActive(step) && isStepCompleted(step)"
                     [class.text-sky-600]="!isStepActive(step) && isStepCompleted(step)"
                     [class.bg-gray-100]="!isStepActive(step) && !isStepCompleted(step)"
                     [class.text-gray-400]="!isStepActive(step) && !isStepCompleted(step)">
                  @if (isStepCompleted(step) && !isStepActive(step)) {
                    <i class="pi pi-check text-base font-bold"></i>
                  } @else {
                    <i class="text-base pi" [ngClass]="getStepIcon(step)"></i>
                  }
                </div>

                <div class="flex-1">
                  <p class="text-sm font-semibold"
                     [class.text-sky-900]="isStepActive(step)"
                     [class.text-gray-900]="!isStepActive(step) && isStepCompleted(step)"
                     [class.text-gray-600]="!isStepActive(step) && !isStepCompleted(step)">
                    {{ getStepTitle(step) }}
                  </p>
                  @if (isStepActive(step)) {
                    <p class="mt-0.5 text-xs text-sky-600">
                      En progreso
                    </p>
                  } @else if (isStepCompleted(step)) {
                    <p class="mt-0.5 text-xs text-gray-500">
                      Completado
                    </p>
                  }
                </div>

                @if (isStepActive(step)) {
                  <i class="pi pi-chevron-right text-sky-600"></i>
                }
              </button>
            }
          </div>
        </aside>

        <!-- Stepper Pills (Mobile) -->
        <div class="flex items-center gap-2 overflow-x-auto pb-2 lg:hidden">
          @for (step of [1, 2]; track step) {
            <button
              type="button"
              (click)="onGoToStep(step)"
              [disabled]="step > 1 && !isStepCompleted(1)"
              class="flex shrink-0 items-center gap-2 rounded-full px-4 py-2 text-sm font-medium transition-all disabled:cursor-not-allowed disabled:opacity-50"
              [class.bg-sky-500]="isStepActive(step)"
              [class.text-white]="isStepActive(step)"
              [class.shadow-lg]="isStepActive(step)"
              [class.bg-sky-100]="!isStepActive(step) && isStepCompleted(step)"
              [class.text-sky-700]="!isStepActive(step) && isStepCompleted(step)"
              [class.bg-gray-100]="!isStepActive(step) && !isStepCompleted(step)"
              [class.text-gray-600]="!isStepActive(step) && !isStepCompleted(step)">
              @if (isStepCompleted(step) && !isStepActive(step)) {
                <i class="pi pi-check text-xs font-bold"></i>
              } @else {
                <i class="text-xs pi" [ngClass]="getStepIcon(step)"></i>
              }
              <span>{{ getStepTitle(step) }}</span>
            </button>
          }
        </div>

        <!-- Form Content -->
        <div class="lg:col-span-9">
          <div class="rounded-xl border border-gray-200 bg-white shadow-sm">

            <!-- Step Header -->
            <div class="border-b border-gray-200 p-6">
              <div class="flex items-start gap-4">
                <div class="flex h-12 w-12 shrink-0 items-center justify-center rounded-full bg-gradient-to-br from-sky-400 to-cyan-500">
                  <i class="text-xl text-white pi" [ngClass]="getStepIcon(store.currentStep())"></i>
                </div>
                <div class="flex-1">
                  <h2 class="text-lg font-semibold text-gray-900">
                    {{ store.currentStepTitle() }}
                  </h2>
                  <p class="mt-1 text-sm text-gray-600">
                    {{ store.currentStepDescription() }}
                  </p>
                </div>
              </div>
            </div>

            <!-- Step Content -->
            <div class="p-6">

              <!-- STEP 1: Datos Personales -->
              @if (store.currentStep() === 1) {
                <div class="space-y-6">

                  <!-- Nombres -->
                  <div class="space-y-2">
                    <label for="names" class="block text-sm font-medium text-gray-700">
                      Nombres
                      <span class="text-red-500">*</span>
                    </label>
                    <input
                      id="names"
                      type="text"
                      [value]="store.formData().names"
                      (input)="onNamesChange($any($event.target).value)"
                      [disabled]="store.isSubmitting()"
                      placeholder="Ej: Juan Carlos"
                      class="block w-full rounded-lg border py-2.5 px-3.5 text-sm text-gray-900 placeholder-gray-400 transition-all focus:outline-none focus:ring-2 disabled:cursor-not-allowed disabled:bg-gray-50 disabled:text-gray-500"
                      [ngClass]="{
                        'border-red-500 focus:border-red-500 focus:ring-red-500/20': store.validationErrors().names,
                        'border-gray-300 focus:border-sky-500 focus:ring-sky-500/20': !store.validationErrors().names
                      }">

                    @if (store.validationErrors().names) {
                      <p class="mt-1.5 flex items-start text-xs text-red-600">
                        <i class="pi pi-exclamation-circle mr-1.5 mt-0.5 text-xs"></i>
                        {{ store.validationErrors().names }}
                      </p>
                    }
                  </div>

                  <div class="grid gap-6 sm:grid-cols-2">
                    <!-- Apellido Paterno -->
                    <div class="space-y-2">
                      <label for="firstSurname" class="block text-sm font-medium text-gray-700">
                        Apellido Paterno
                        <span class="text-red-500">*</span>
                      </label>
                      <input
                        id="firstSurname"
                        type="text"
                        [value]="store.formData().firstSurname"
                        (input)="onFirstSurnameChange($any($event.target).value)"
                        [disabled]="store.isSubmitting()"
                        placeholder="Ej: Pérez"
                        class="block w-full rounded-lg border py-2.5 px-3.5 text-sm text-gray-900 placeholder-gray-400 transition-all focus:outline-none focus:ring-2 disabled:cursor-not-allowed disabled:bg-gray-50 disabled:text-gray-500"
                        [ngClass]="{
                          'border-red-500 focus:border-red-500 focus:ring-red-500/20': store.validationErrors().firstSurname,
                          'border-gray-300 focus:border-sky-500 focus:ring-sky-500/20': !store.validationErrors().firstSurname
                        }">

                      @if (store.validationErrors().firstSurname) {
                        <p class="mt-1.5 flex items-start text-xs text-red-600">
                          <i class="pi pi-exclamation-circle mr-1.5 mt-0.5 text-xs"></i>
                          {{ store.validationErrors().firstSurname }}
                        </p>
                      }
                    </div>

                    <!-- Apellido Materno -->
                    <div class="space-y-2">
                      <label for="secondSurname" class="block text-sm font-medium text-gray-700">
                        Apellido Materno
                        <span class="text-red-500">*</span>
                      </label>
                      <input
                        id="secondSurname"
                        type="text"
                        [value]="store.formData().secondSurname"
                        (input)="onSecondSurnameChange($any($event.target).value)"
                        [disabled]="store.isSubmitting()"
                        placeholder="Ej: García"
                        class="block w-full rounded-lg border py-2.5 px-3.5 text-sm text-gray-900 placeholder-gray-400 transition-all focus:outline-none focus:ring-2 disabled:cursor-not-allowed disabled:bg-gray-50 disabled:text-gray-500"
                        [ngClass]="{
                          'border-red-500 focus:border-red-500 focus:ring-red-500/20': store.validationErrors().secondSurname,
                          'border-gray-300 focus:border-sky-500 focus:ring-sky-500/20': !store.validationErrors().secondSurname
                        }">

                      @if (store.validationErrors().secondSurname) {
                        <p class="mt-1.5 flex items-start text-xs text-red-600">
                          <i class="pi pi-exclamation-circle mr-1.5 mt-0.5 text-xs"></i>
                          {{ store.validationErrors().secondSurname }}
                        </p>
                      }
                    </div>
                  </div>

                  <!-- Género -->
                  <div class="space-y-2">
                    <label for="gender" class="block text-sm font-medium text-gray-700">
                      Género
                      <span class="text-red-500">*</span>
                    </label>

                    <p-select
                      inputId="gender"
                      [options]="genderOptions"
                      [(ngModel)]="store.formData().gender"
                      (onChange)="onGenderChange($event.value)"
                      optionLabel="label"
                      optionValue="value"
                      placeholder="Selecciona un género"
                      [disabled]="store.isSubmitting()"
                      [showClear]="false"
                      [style]="{ width: '100%' }"
                      class="w-full">
                    </p-select>
                  </div>

                  <!-- Tipo de Documento -->
                  <div class="space-y-2">
                    <label for="documentType" class="block text-sm font-medium text-gray-700">
                      Tipo de Documento
                      <span class="text-red-500">*</span>
                    </label>

                    <p-select
                      inputId="documentType"
                      [options]="documentTypeOptions"
                      [(ngModel)]="store.formData().identityDocumentType"
                      (onChange)="onDocumentTypeChange($event.value)"
                      optionLabel="label"
                      optionValue="value"
                      placeholder="Selecciona tipo de documento"
                      [disabled]="store.isSubmitting()"
                      [showClear]="false"
                      [style]="{ width: '100%' }"
                      class="w-full">

                      <ng-template let-option pTemplate="item">
                        <div class="py-2">
                          <p class="text-sm font-medium text-gray-900">
                            {{ option.label }}
                          </p>
                          <p class="mt-0.5 text-xs text-gray-600">
                            {{ option.description }}
                          </p>
                        </div>
                      </ng-template>
                    </p-select>
                  </div>

                  <!-- Número de Documento -->
                  <div class="space-y-2">
                    <label for="documentNumber" class="block text-sm font-medium text-gray-700">
                      Número de Documento
                      <span class="text-red-500">*</span>
                    </label>
                    <input
                      id="documentNumber"
                      type="text"
                      [value]="store.formData().identityDocumentNumber"
                      (input)="onDocumentNumberChange($any($event.target).value)"
                      [disabled]="store.isSubmitting() || !store.formData().identityDocumentType"
                      [placeholder]="store.formData().identityDocumentType ? 'Ingresa el número' : 'Primero selecciona el tipo'"
                      class="block w-full rounded-lg border py-2.5 px-3.5 font-mono text-sm text-gray-900 placeholder-gray-400 transition-all focus:outline-none focus:ring-2 disabled:cursor-not-allowed disabled:bg-gray-50 disabled:text-gray-500"
                      [ngClass]="{
                        'border-red-500 focus:border-red-500 focus:ring-red-500/20': store.validationErrors().identityDocumentNumber,
                        'border-gray-300 focus:border-sky-500 focus:ring-sky-500/20': !store.validationErrors().identityDocumentNumber
                      }">

                    @if (store.validationErrors().identityDocumentNumber) {
                      <p class="mt-1.5 flex items-start text-xs text-red-600">
                        <i class="pi pi-exclamation-circle mr-1.5 mt-0.5 text-xs"></i>
                        {{ store.validationErrors().identityDocumentNumber }}
                      </p>
                    }
                  </div>

                </div>
              }

              <!-- STEP 2: Configuración y Confirmación -->
              @if (store.currentStep() === 2) {
                <div class="space-y-6">

                  <!-- Email -->
                  <div class="space-y-2">
                    <label for="email" class="block text-sm font-medium text-gray-700">
                      Email
                      <span class="text-red-500">*</span>
                    </label>
                    <input
                      id="email"
                      type="email"
                      [value]="store.formData().email"
                      (input)="onEmailChange($any($event.target).value)"
                      [disabled]="store.isSubmitting()"
                      placeholder="ejemplo@correo.com"
                      class="block w-full rounded-lg border py-2.5 px-3.5 text-sm text-gray-900 placeholder-gray-400 transition-all focus:outline-none focus:ring-2 disabled:cursor-not-allowed disabled:bg-gray-50 disabled:text-gray-500"
                      [ngClass]="{
                        'border-red-500 focus:border-red-500 focus:ring-red-500/20': store.validationErrors().email,
                        'border-gray-300 focus:border-sky-500 focus:ring-sky-500/20': !store.validationErrors().email
                      }">

                    @if (store.validationErrors().email) {
                      <p class="mt-1.5 flex items-start text-xs text-red-600">
                        <i class="pi pi-exclamation-circle mr-1.5 mt-0.5 text-xs"></i>
                        {{ store.validationErrors().email }}
                      </p>
                    } @else {
                      <p class="mt-1.5 text-xs text-gray-500">
                        <i class="pi pi-info-circle mr-1"></i>
                        Este email se usará para comunicaciones
                      </p>
                    }
                  </div>

                  <!-- Crear Usuario -->
                  <div class="rounded-lg border border-gray-200 bg-gray-50 p-4">
                    <div class="flex items-start justify-between gap-4">
                      <div class="flex-1">
                        <label for="createUser" class="block text-sm font-semibold text-gray-900">
                          Crear cuenta de usuario
                        </label>
                        <p class="mt-1 text-xs text-gray-600">
                          Al activar esta opción, se creará una cuenta de acceso al sistema para este colaborador.
                        </p>
                        @if (store.formData().shouldCreateUser) {
                          <div class="mt-3 rounded-lg border border-sky-200 bg-sky-50 p-3">
                            <div class="flex items-start gap-2">
                              <i class="pi pi-info-circle mt-0.5 text-sm text-sky-600"></i>
                              <div class="flex-1">
                                <p class="text-xs font-medium text-sky-900">
                                  Credenciales de acceso
                                </p>
                                <p class="mt-1 text-xs text-sky-700">
                                  <strong>Usuario:</strong> {{ store.formData().email }}
                                </p>
                                <p class="mt-0.5 text-xs text-sky-700">
                                  <strong>Contraseña inicial:</strong> {{ store.formData().identityDocumentNumber || '(completar documento)' }}
                                </p>
                              </div>
                            </div>
                          </div>
                        }
                      </div>

                      <p-toggle-switch
                        inputId="createUser"
                        [(ngModel)]="store.formData().shouldCreateUser"
                        (onChange)="onShouldCreateUserChange($event.checked)"
                        [disabled]="store.isSubmitting()">
                      </p-toggle-switch>
                    </div>
                  </div>

                  <!-- Upload de Foto -->
                  <div class="space-y-2">
                    <label class="block text-sm font-medium text-gray-700">
                      Foto de Perfil
                      <span class="text-xs font-normal text-gray-500">(Opcional)</span>
                    </label>

                    @if (store.photoPreviewUrl()) {
                      <!-- Preview de foto -->
                      <div class="flex items-center gap-4">
                        <img
                          [src]="store.photoPreviewUrl()"
                          alt="Preview"
                          class="h-24 w-24 rounded-full object-cover ring-4 ring-sky-100">

                        <div class="flex-1">
                          <p class="text-sm font-medium text-gray-900">
                            Foto seleccionada
                          </p>
                          <p class="mt-0.5 text-xs text-gray-600">
                            {{ store.formData().photoFile?.name }}
                          </p>
                          <button
                            pRipple
                            type="button"
                            (click)="onClearPhoto()"
                            [disabled]="store.isSubmitting() || store.isUploadingPhoto()"
                            class="mt-2 flex items-center gap-1.5 text-xs font-medium text-red-600 hover:text-red-700 disabled:cursor-not-allowed disabled:opacity-50">
                            <i class="pi pi-trash text-xs"></i>
                            Eliminar foto
                          </button>
                        </div>
                      </div>
                    } @else {
                      <!-- Upload button -->
                      <label
                        class="group relative flex cursor-pointer flex-col items-center justify-center rounded-lg border-2 border-dashed border-gray-300 bg-white p-6 transition-all hover:border-sky-400 hover:bg-sky-50"
                        [class.cursor-not-allowed]="store.isSubmitting()"
                        [class.opacity-50]="store.isSubmitting()">

                        <div class="flex h-16 w-16 items-center justify-center rounded-full bg-gradient-to-br from-sky-100 to-cyan-100 transition-all group-hover:from-sky-200 group-hover:to-cyan-200">
                          <i class="pi pi-camera text-2xl text-sky-600"></i>
                        </div>

                        <p class="mt-4 text-sm font-medium text-gray-900">
                          Seleccionar foto
                        </p>
                        <p class="mt-1 text-xs text-gray-600">
                          PNG, JPG, JPEG o WEBP hasta 5MB
                        </p>

                        <input
                          type="file"
                          accept="image/*"
                          (change)="onPhotoSelect($event)"
                          [disabled]="store.isSubmitting()"
                          class="sr-only">
                      </label>
                    }

                    @if (store.validationErrors().photoFile) {
                      <p class="mt-1.5 flex items-start text-xs text-red-600">
                        <i class="pi pi-exclamation-circle mr-1.5 mt-0.5 text-xs"></i>
                        {{ store.validationErrors().photoFile }}
                      </p>
                    }
                  </div>

                  <!-- Resumen -->
                  @if (store.isStep2Valid()) {
                    <div class="rounded-xl border-2 border-dashed border-sky-200 bg-sky-50/50 p-6">
                      <div class="mb-3 flex items-center gap-2 text-sm font-medium text-sky-700">
                        <i class="pi pi-eye text-base"></i>
                        <span>Resumen del colaborador</span>
                      </div>

                      <div class="rounded-lg border border-sky-200 bg-white p-4">
                        <div class="flex items-start gap-4">
                          <!-- Avatar o Iniciales -->
                          @if (store.photoPreviewUrl()) {
                            <img
                              [src]="store.photoPreviewUrl()"
                              alt="Avatar"
                              class="h-16 w-16 rounded-full object-cover ring-4 ring-sky-100">
                          } @else {
                            <div class="flex h-16 w-16 items-center justify-center rounded-full bg-gradient-to-br from-sky-400 to-cyan-500 text-white ring-4 ring-sky-100">
                              <span class="text-xl font-bold">
                                {{ store.formData().names.charAt(0).toUpperCase() }}{{ store.formData().firstSurname.charAt(0).toUpperCase() }}
                              </span>
                            </div>
                          }

                          <!-- Info -->
                          <div class="flex-1">
                            <h3 class="text-base font-semibold text-gray-900">
                              {{ store.fullName() }}
                            </h3>
                            <p class="mt-1 text-sm text-gray-600">
                              {{ getGenderLabel(store.formData().gender!) }}
                            </p>
                            <div class="mt-2 space-y-1 text-xs text-gray-600">
                              <p>
                                <i class="pi pi-id-card mr-1.5 text-xs text-gray-400"></i>
                                {{ getDocumentTypeLabel(store.formData().identityDocumentType!) }}: {{ store.formData().identityDocumentNumber }}
                              </p>
                              <p>
                                <i class="pi pi-envelope mr-1.5 text-xs text-gray-400"></i>
                                {{ store.formData().email }}
                              </p>
                              @if (store.formData().shouldCreateUser) {
                                <p class="flex items-center gap-1.5 text-sky-700">
                                  <i class="pi pi-check-circle text-xs"></i>
                                  <span class="font-medium">Con cuenta de usuario</span>
                                </p>
                              }
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  }

                </div>
              }

            </div>

            <!-- Step Actions -->
            <div class="border-t border-gray-200 p-4">
              <div class="flex items-center justify-between gap-3">

                <!-- Previous Button -->
                <button
                  pRipple
                  type="button"
                  (click)="onPrevious()"
                  [disabled]="store.currentStep() === 1 || store.isSubmitting()"
                  class="flex items-center gap-2 rounded-lg border border-gray-300 bg-white px-4 py-2.5 text-sm font-medium text-gray-700 transition-all hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50">
                  <i class="pi pi-arrow-left text-sm"></i>
                  <span>Anterior</span>
                </button>

                <!-- Next / Submit Button -->
                @if (store.currentStep() < store.totalSteps()) {
                  <button
                    pRipple
                    type="button"
                    (click)="onNext()"
                    [disabled]="!store.canGoNext() || store.isSubmitting()"
                    class="flex items-center gap-2 rounded-lg bg-gradient-to-r from-sky-500 to-cyan-500 px-5 py-2.5 text-sm font-semibold text-white shadow-lg shadow-sky-500/25 transition-all hover:shadow-xl hover:shadow-sky-500/40 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 disabled:cursor-not-allowed disabled:from-gray-300 disabled:to-gray-300 disabled:shadow-none">
                    <span>Siguiente</span>
                    <i class="pi pi-arrow-right text-sm"></i>
                  </button>
                } @else {
                  <button
                    pRipple
                    type="button"
                    (click)="onSubmit()"
                    [disabled]="!store.canSubmit()"
                    class="flex items-center gap-2 rounded-lg bg-gradient-to-r from-sky-500 to-cyan-500 px-5 py-2.5 text-sm font-semibold text-white shadow-lg shadow-sky-500/25 transition-all hover:shadow-xl hover:shadow-sky-500/40 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-offset-2 disabled:cursor-not-allowed disabled:from-gray-300 disabled:to-gray-300 disabled:shadow-none">
                    @if (store.isSubmitting()) {
                      <i class="pi pi-spinner pi-spin text-sm"></i>
                      <span>{{ store.isUploadingPhoto() ? 'Subiendo foto...' : 'Creando colaborador...' }}</span>
                    } @else {
                      <i class="pi pi-check text-sm"></i>
                      <span>Crear Colaborador</span>
                    }
                  </button>
                }

              </div>
            </div>

          </div>
        </div>

      </div>

    </div>
  </main>

</div>
